<?php
	/**
	 * t3tool-sqlq.phpsh
	 *
	 * Handles the command "t3tool sqlq <sql>".
	 *
	 * @package t3tool
	 * @author Lars KÃ¸ie
	 *
	 */

	/**
	 * @param $args
	 */
	function t3tool_ts_handlecmd($args) {

		if (file_exists(PATH_script . 'includes/class.t3tool_ts_handler.php')) {
			require_once (PATH_script . 'includes/class.t3tool_ts_handler.php');
		}
		if (file_exists('/usr/local/bin/tools/t3tool/includes/class.t3tool_ts_handler.php')) {
			require_once (PATH_script . 'includes/class.t3tool_ts_handler.php');
		}

		$cmd = array_shift($args);

		switch ($cmd) {


			case 'diff' :

				if (! trim($args[1])) {
					output_usage('Usage: t3tool ts diff <ts-1> <ts-2>
');
				}

				foreach (array($args[0], $args[1]) as $i => $ts) {
					if ($abs_file[$i] = t3tool_get_absolute_path($ts)) {
						$serialized = t3tool_ts_parse_file_to_serialized($abs_file[$i]);
						$config[$i] = unserialize($serialized);

					} else {
						die('file not found : ' . $ts);
						// could it be a string or something else ?

					}
				}

				t3tool_ts_handler::output_formatted_ts_diff($config[0], $config[1]);

				break;
			#

			#

			/*
			 * Parse
			 */
			case 'parse' :
				$serialized = t3tool_ts_parse_file_to_serialized($args[0]);
				return print_r(unserialize($serialized), TRUE);

				break;

			/**
			 *
			 */
			case 'parse-to-serialized' :

				$serialized = t3tool_ts_parse_file_to_serialized($args[0]);
				echo $serialized;
				break;

			/**
			 *
			 */
			case 'parse-to-yaml' :
				$serialized = t3tool_ts_parse_file_to_serialized($args[0]);
				return yaml_emit(unserialize($serialized));
				break;

			/**
			 *
			 */
			case 'parse-to-php' :

				$serialized = t3tool_ts_parse_file_to_serialized($args[0]);

				return '<?php return ' .
				var_export(unserialize($serialized), TRUE) .
				";";

				break;


			default :
				return ("  t3tool ts list
    List all templates.
  t3tool template show <uid or title>
    Show single template with all fields.

");


		}
	}

	/**
	 * Filename can be a directory.
	 *
	 * @param $filename
	 * @return string
	 */
	function t3tool_ts_parse_file_to_serialized ($filename) {
		$abs_file = t3tool_get_absolute_path($filename);
		$cmd = "ts parse-to-serialized " . escapeshellarg($abs_file);
		$encoded = t3tool_call_internal_ext_t3tool($cmd);
		$serialized = base64_decode($encoded);
		return $serialized;
	}

	function t3tool_ts_usage_short() {
		return ("TypoScript commands:
");

	}

	function t3tool_ts_cmdaliases() {
		return array(
		);
	}

	/**
	 * @return array
	 */
	function t3tool_ts_completion() {
		return array(
			'ts' => array(
				'diff' => '_path,_path',
				'parse' => '_path',
				'parse-to-serialized' => '_path',
				'parse-to-yaml' => '_path',
				'parse-to-php' => '_path',
			),
		);

	}
